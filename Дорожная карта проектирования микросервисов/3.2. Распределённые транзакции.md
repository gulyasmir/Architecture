# Распределённые транзакции

Когда операции охватывают несколько сервисов, обеспечение согласованности и целостности данных требует управления распределёнными транзакциями. Распределённые транзакции сложны из-за необходимости поддерживать свойства ACID (Atomicity, Consistency, Isolation, Durability) в различных сервисах.

Распределённые транзакции координируют выполнение операций в нескольких сервисах, чтобы гарантировать, что все части транзакции либо зафиксируются, либо откатятся вместе. Для решения этих задач существуют разные подходы.

## **Протокол двухфазной фиксации (2 Phase Commit, 2PC)**

Протокол двухфазной фиксации (2PC) — это распространённый подход к управлению распределёнными транзакциями. Он включает в себя две фазы:

1. **Фаза подготовки**, когда координатор отправляет сообщение `<span class="code-inline__content">prepare</span>` всем участвующим сервисам с просьбой подготовиться к фиксации транзакции. На что каждый сервис отвечает голосованием (зафиксировать или прервать) в зависимости от того, сможет ли он успешно зафиксировать транзакцию.
2. **Фаза фиксации** — если все сервисы голосуют за фиксацию, координатор отправляет сообщение о фиксации всем сервисам, указывая им на фиксацию транзакции. Если какая-либо служба голосует за отказ, координатор посылает сообщение об отказе, предписывая всем службам откатить транзакцию.

**Проблемы 2PC:**

* **Блокировка.** Если координатор не справляется, участники могут остаться в неопределённом состоянии, ожидая решения.
* **Производительность.** Протокол может вносить задержки из-за необходимости многократных обходов между координатором и участниками.

## **Паттерн Saga**

Паттерн Saga предоставляет собой альтернативный подход к управлению распределёнными транзакциями, разбивая их на серию более мелких, компенсируемых транзакций. Каждая транзакция в саге обновляет систему и публикует событие или сообщение для запуска следующей транзакции. Если шаг не удался, выполняются компенсирующие транзакции, чтобы отменить изменения, сделанные предыдущими транзакциями.

**Преимущества шаблона Saga:**

* **Неблокируемость.** В отличие от 2PC, паттерн Saga не блокирует сервисы, поскольку каждый шаг независим и может быть отменён при необходимости.
* **Масштабируемость.** Он более масштабируем и устойчив к сбоям, что делает его подходящим для крупномасштабных распределённых систем.

В следующем уроке мы углубимся в паттерн Saga, изучим его реализацию и то, как он может быть использован для эффективного управления распределёнными транзакциями.
